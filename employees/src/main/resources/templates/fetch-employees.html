<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee List</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link th:href="@{/css/user-profile.css}" rel="stylesheet">
    <style>
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .employee-list-title {
            margin-bottom: 10px;
        }
        .total-employees {
            font-size: 16px;
            color: #555;
        }
        .table-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>

<div class="container mt-3">
    <div class="header-container">
        <div class="left">
            <h2>Employee List</h2>
            <p class="total-employees">Total Employees: <span th:text="${employeeCount ?: 0}">0</span></p>
        </div>
        <div th:replace="~{fragments/userProfileBox :: userProfile}"></div>
    </div>
    <!-- Debug Outputs -->
    <!--    <p th:text="'Debug: Current User = ' + ${#authentication?.name ?: 'Unknown'}"></p>-->
    <!--    <p th:text="'Debug: User Roles = ' + ${#authentication?.authorities ?: 'None'}"></p>-->
    <!--    <p th:text="'Debug: Is Admin = ' + ${isAdmin}"></p>-->

    <!-- New Flex Container for Delete Button and Pagination -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <button type="button" class="btn btn-danger" id="deleteSelected" disabled data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal" th:if="${isAdmin}">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                Delete Selected
            </button>
        </div>
        <div th:replace="~{fragments/pagination :: pagination(currentPage=${currentPage}, totalPages=${totalPages}, pageSize=${pageSize})}"></div>
    </div>

    <div th:if="${response != null}" class="alert"
         th:classappend="${response.status == 'success'} ? 'alert-success' : 'alert-danger'">
        <span th:text="${response.message}"></span>
    </div>

    <form th:action="@{/web/employees/batchDelete}" method="post" id="employeeForm">
        <!-- Hidden inputs for pagination parameters -->
        <input type="hidden" name="page" th:value="${currentPage}"/>
        <input type="hidden" name="size" th:value="${pageSize}"/>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th scope="col" th:if="${isAdmin}"><label for="selectAll"></label><input type="checkbox"
                                                                                             id="selectAll"></th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Employee ID</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">First Name</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Last Name</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Date Of Birth</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Gender</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Salary</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Hire Date</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Job Stage</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Designation</th>
                    <th scope="col" style="white-space: normal; word-wrap: break-word;">Manager EmployeeID</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="employee : ${employees != null ? employees : {}}">
                    <td th:if="${isAdmin}">
                        <input type="checkbox" th:name="selectedIds" th:value="${employee.employeeId}"
                               class="employee-checkbox" aria-label="Select employee">
                    </td>
                    <td>
                        <a th:if="${isAdmin}"
                           th:href="@{/web/employees/updateEmployees/{employeeId}(employeeId=${employee.employeeId})}"
                           th:text="${employee.employeeId}"></a>
                        <span th:unless="${isAdmin}" th:text="${employee.employeeId}"></span>
                    </td>
                    <td th:text="${employee.firstName}"></td>
                    <td th:text="${employee.lastName}"></td>
                    <td th:text="${#dates.format(employee.dateOfBirth, 'yyyy-MM-dd')}"></td>
                    <td th:text="${employee.gender}"></td>
                    <td th:text="${employee.salary}"></td>
                    <td th:text="${#dates.format(employee.hireDate, 'yyyy-MM-dd')}"></td>
                    <td th:text="${employee.jobStage}"></td>
                    <td th:text="${employee.designation}"></td>
                    <td style="width: 80px; max-width: 80px;" th:text="${employee.managerEmployeeId}"></td>
                </tr>
                <tr th:if="${employeeCount==0}">
                    <td th:colspan="${isAdmin ? 11 : 10}" class="text-center">No employees found</td>
                </tr>
                </tbody>
            </table>
        </div>
    </form>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel"
         aria-hidden="true" th:if="${isAdmin}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="deleteModalBody">
                    Are you sure you want to delete the selected employees? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" aria-describedby="deleteModalBody"
                            onclick="submitDeleteForm()">Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script>
    const selectAllCheckbox = document.getElementById('selectAll');
    const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
    const deleteButton = document.getElementById('deleteSelected');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            employeeCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
            updateSubmitButton();
        });
    }

    if (employeeCheckboxes.length > 0) {
        employeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSubmitButton);
        });
    }

    function updateSubmitButton() {
        if (deleteButton) {
            const anyChecked = Array.from(employeeCheckboxes).some(checkbox => checkbox.checked);
            deleteButton.disabled = !anyChecked;
        }
    }

    function submitDeleteForm() {
        const spinner = document.querySelector('#deleteSelected .spinner-border');
        if (spinner) {
            spinner.classList.remove('d-none');
        }
        document.getElementById('employeeForm').submit();
    }
</script>
</body>
</html>