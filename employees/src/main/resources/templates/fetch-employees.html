<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee List</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>

<div class="container mt-3">
    <h2>Employee List</h2>
    <p>
        <span class="badge bg-primary" th:text="'Total Employees: ' + ${employeeCount != null ? employeeCount : '0'}" aria-label="Total number of employees"></span>
    </p>
    <!-- Debug Outputs -->
    <p th:text="'Debug: Current User = ' + ${#authentication?.name ?: 'Unknown'}"></p>
    <p th:text="'Debug: User Roles = ' + ${#authentication?.authorities ?: 'None'}"></p>
    <p th:text="'Debug: Is Admin = ' + ${isAdmin}"></p>

    <div th:if="${response != null}" class="alert" th:classappend="${response.status == 'success'} ? 'alert-success' : 'alert-danger'">
        <span th:text="${response.message}"></span>
    </div>

    <form th:action="@{/web/employees/batchDelete}" method="post" id="employeeForm">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th th:if="${isAdmin}">
                        <input type="checkbox" id="selectAll" aria-label="Select all employees">
                    </th>
                    <th>Employee ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Date Of Birth</th>
                    <th>Gender</th>
                    <th>Salary</th>
                    <th>Hire Date</th>
                    <th>Job Stage</th>
                    <th>Designation</th>
                    <th>Manager EmployeeID</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="employee : ${employees != null ? employees : {}}">
                    <td th:if="${isAdmin}">
                        <input type="checkbox" th:name="selectedIds" th:value="${employee.employeeId}" class="employee-checkbox" aria-label="Select employee">
                    </td>
                    <td th:text="${employee.employeeId != null ? employee.employeeId : 'N/A'}"></td>
                    <td th:text="${employee.firstName != null ? employee.firstName : 'N/A'}"></td>
                    <td th:text="${employee.lastName != null ? employee.lastName : 'N/A'}"></td>
                    <td th:text="${employee.dateOfBirth != null ? employee.dateOfBirth : 'N/A'}"></td>
                    <td th:text="${employee.gender != null ? employee.gender : 'N/A'}"></td>
                    <td th:text="${employee.salary != null ? employee.salary : 'N/A'}"></td>
                    <td th:text="${employee.hireDate != null ? employee.hireDate : 'N/A'}"></td>
                    <td th:text="${employee.jobStage != null ? employee.jobStage : 'N/A'}"></td>
                    <td th:text="${employee.designation != null ? employee.designation : 'N/A'}"></td>
                    <td th:text="${employee.managerEmployeeId != null ? employee.managerEmployeeId : 'N/A'}"></td>
                </tr>
                <tr th:if="${employees == null or employees.isEmpty}">
                    <td th:colspan="${isAdmin ? 11 : 10}" class="text-center">No employees found</td>
                </tr>
                </tbody>
            </table>
        </div>
        <button type="button" class="btn btn-danger" id="deleteSelected" disabled data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" th:if="${isAdmin}">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Delete Selected
        </button>
    </form>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true" th:if="${isAdmin}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="deleteModalBody">
                    Are you sure you want to delete the selected employees? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" aria-describedby="deleteModalBody" onclick="submitDeleteForm()">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script>
    const selectAllCheckbox = document.getElementById('selectAll');
    const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
    const deleteButton = document.getElementById('deleteSelected');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            employeeCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
            updateSubmitButton();
        });
    }

    if (employeeCheckboxes.length > 0) {
        employeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSubmitButton);
        });
    }

    function updateSubmitButton() {
        if (deleteButton) {
            const anyChecked = Array.from(employeeCheckboxes).some(checkbox => checkbox.checked);
            deleteButton.disabled = !anyChecked;
        }
    }

    function submitDeleteForm() {
        const spinner = document.querySelector('#deleteSelected .spinner-border');
        if (spinner) {
            spinner.classList.remove('d-none');
        }
        document.getElementById('employeeForm').submit();
    }
</script>
</body>
</html>